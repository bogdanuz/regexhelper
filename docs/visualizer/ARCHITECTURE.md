# Архитектура визуализатора — RegexHelper

Структура и поток данных инструмента «Визуализатор». Реализована интеграция с **regexper-static**.

**Дата создания:** 2026-02-17  
**Статус:** Реализовано. Бандл regexper в **assets/libs/regexper/**, UI и синхронизация в **tools/visualizer/app.js**.

**Документы визуализатора (docs/visualizer/):** SPECIFICATION.md, ARCHITECTURE.md (этот файл), SETUP_INSTRUCTIONS.md (установка бандла), TESTING.md. Завершённый план интеграции — archive/IMPLEMENTATION_PLAN_VISUALIZER.md. Референс: [regexper.com](https://regexper.com/), [documentation](https://regexper.com/documentation.html). **Связанные (уровень проекта):** docs/PROJECT_PRINCIPLES.md, docs/STRUCTURE.md, docs/DEPENDENCY_MAP.md.

---

## Назначение

Визуализация регулярных выражений в виде railroad-диаграмм. Референс: [regexper.com](https://regexper.com/). Спецификация: **SPECIFICATION.md**.

---

## Точка входа

- **main.js** импортирует `initVisualizer` из **tools/visualizer/app.js** и вызывает при загрузке DOM (вместе с initApp конвертера).
- **index.html**: секция `#visualizer`, внутри `#content` и `.application` (селектор инициализации regexper), форма `#regexp-form`, поле `#regexp-input`, контейнер `#regexp-render`, шаблон `#svg-container-base`. Подключены стили visualizer.css, regexper.css, regexper-overrides.css, regexper-reset.css; скрипт **assets/libs/regexper/regexper.js** до main.js.

---

## Поток данных

1. Пользователь вводит regex в textarea или вставляет кнопкой «Вставить».
2. По клику «Визуализировать» **app.js** предотвращает отправку формы, кодирует выражение для hash (encodeRegexForHash), выставляет `location.hash` и диспатчит `hashchange`.
3. Бандл **regexper** слушает `hashchange`, декодирует hash, вызывает свой парсер/рендерер и пишет SVG в `#regexp-render`. Состояние выставляется на `document.body.className` (has-results, has-error, is-loading).
4. **app.js** наблюдает за body (MutationObserver) и за появлением SVG в `#regexp-render`, показывает/скрывает плейсхолдер, индикатор загрузки и вьюпорт, восстанавливает класс `page-wrapper` на body. При hash секции (#visualizer) всегда показывается наша подсказка, а не заглушка regexper. При загрузке страницы панель визуализатора сбрасывается (`resetVisualizerPanel`: пустое поле, очистка контейнера диаграммы, без hash); та же функция экспортирована и вызывается из конвертера при нажатии «Сбросить» в шапке (полный сброс всех инструментов, история сохраняется). **Во время построения диаграммы (is-loading):** сразу показываются белое поле (вьюпорт), по центру — анимация загрузки (три пульсирующие точки) и панель экспорта/зума внизу (без мигания при переходе к результату). **При готовой диаграмме (has-results):** анимация скрывается, отображается диаграмма, панель остаётся на месте. **При ошибке regex (has-error):** показывается ровно один тост за одну попытку: флаги `errorToastScheduled` и `errorToastShownThisAttempt`; сброс этих флагов только при сабмите формы, при переходе по hash секции и в resetVisualizerPanel (в ветке has-results сброс не выполняется, чтобы при переключении regexper has-error ↔ has-results не появлялись лишние тосты).
5. **Панель под диаграммой:** одна кнопка «Скачать» с выпадающим меню (раскрывается вправо по горизонтали; пункты SVG и PNG в один ряд, плавное открытие по классу is-open, без обводки контейнера); кнопки зума (−, 100%, +) и кнопка «Раскрыть на весь экран» (текст на кнопке, одного размера с «Скачать»). Зум при пустой диаграмме выдаёт тост. Масштаб применяется от левого верхнего угла (transform-origin 0 0); контейнеру и обёртке скролла задаётся размер масштабированной диаграммы — скролл до всех краёв, диаграмма не обрезается. **Масштаб по Ctrl + колёсико мыши** в области диаграммы. На кнопках зума — подсказка (title) о Ctrl+колёсико. **Пан:** направление инвертировано (вниз → контент вверх, вправо → влево). **Экспорт:** SVG и PNG из текущего SVG с DIAGRAM_EXPORT_STYLES; PNG 2× (PNG_EXPORT_SCALE). Имя файла: `formatDiagramFilename()` → DD-MM-YYYY_HH-mm. **Область диаграммы:** до построения — адаптивная высота (35vh–60vh), класс has-diagram при отображённой диаграмме (75vh–85vh). **Поле ввода:** без max-height, пользователь раскрывает вручную (resize: vertical).
6. **Модальное окно на весь экран:** по кнопке «Раскрыть на весь экран» открывается оверлей; в нём клон #regexp-render, тулбар с экспортом SVG/PNG и зумом, область с паном. **Зум по Ctrl + колёсико** в модалке так же, как в панели; при зуме размер области прокрутки задаётся явно. Закрытие — кнопка × или клик по оверлею.

---

## Ключевые модули

| Модуль | Назначение |
|--------|------------|
| **tools/visualizer/app.js** | initVisualizer: сброс панели при загрузке и при «Сбросить» в шапке (resetVisualizerPanel экспортирована), кнопка «Очистить» в шапке, наблюдатели body и #regexp-render, обработка hash секции, форма (submit, Вставить). **Экспорт:** одна кнопка «Скачать» с выпадающим меню (SVG/PNG в ряд вправо, открытие по is-open, плавная анимация). **Зум:** кнопки −/+, Ctrl+колёсико в области диаграммы и в модалке; подсказки на кнопках зума. Размеры SVG получаются через `getNaturalSvgSize()` (getBBox/viewBox), к масштабированным размерам добавляется padding (DIAGRAM_PADDING × 2 = 72px); при зуме контейнерам (innerEl, scrollWrap) задаются корректные размеры для полного скролла без обрезания. При генерации новой диаграммы зум сбрасывается на 100%. **Класс has-diagram** на области диаграммы при отображённой диаграмме (адаптивная высота до/после). Кнопка «Раскрыть на весь экран» (текст на кнопке). Pan (инвертированное направление). Модальное окно: клон диаграммы, зум/пан/экспорт, Ctrl+колёсико, `getModalNaturalSvgSize()` для корректного расчёта размеров. При has-error — один тост за попытку. Экспорт: resetVisualizerPanel, encodeRegexForHash, formatDiagramFilename. |
| **assets/libs/regexper/regexper.js** | Бандл regexper-static: парсер regex → AST, рендер SVG, инициализация по `#content .application`, форма, hash, ссылки на экспорт. В проекте применён патч отступов (padding 10→16, 5→8) для «охранных полей» между элементами; при обновлении бандла патч нужно повторить — см. **SETUP_INSTRUCTIONS.md**. |
| **tools/visualizer/css/** | visualizer.css (область диаграммы: до построения — адаптивная высота 35vh–60vh, с диаграммой — has-diagram и 75vh–85vh; индикатор загрузки — три точки по центру; обёртка скролла с классом `visualizer-scroll-wrap--zoomed` при зуме (сбрасывает min-width/height и fit-content); inner с классом `--zoomed` при зуме (box-sizing: border-box, сброс min-width/height); выпадающее меню «Скачать» вправо, без обводки контейнера, плавное открытие; кнопка «Раскрыть на весь экран» одной высоты с «Скачать»; padding 36px), regexper-overrides.css (поле диаграммы белое, палитра с контрастом, max-width: none при zoomed), regexper-reset.css. |

---

## Зависимости

- **shared/** — notifications.js (toast при ошибках).
- **core/** — не импортируется напрямую; стили используют CSS-переменные из common.css.
- **assets/libs/regexper/** — regexper.js, regexper.css (обязательны после сборки/копирования по **SETUP_INSTRUCTIONS.md**).

---

## Интеграция в проект

- Визуализатор — отдельный инструмент; не трогает модули конвертера.
- Навигация в header: ссылка «Визуализатор» ведёт к `#visualizer`; подсветка активного раздела по скроллу — общая логика страницы.

---

## Папки

- **tools/visualizer/** — app.js, **css/** (visualizer, regexper-overrides, regexper-reset), **scripts/** (fetch-regexper-static.ps1).
- **assets/libs/regexper/** — regexper.js (с локальным патчом отступов), regexper.css (копируются скриптом или вручную; обновления только вручную, см. SETUP_INSTRUCTIONS.md).
