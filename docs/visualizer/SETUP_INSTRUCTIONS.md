# Инструкция: запуск визуализатора (regexper-static)

Пошаговая инструкция для получения бандла regexper-static и запуска визуализатора.

**Папка assets/libs/regexper/** предназначена для собранных файлов (regexper.js, regexper.css). Без них визуализатор не работает. Ниже — как получить и скопировать файлы.

---

## Шаг 0. Что нужно

- **Node.js** и **Yarn** (или npm)
- **Git**
- Терминал (PowerShell или CMD)

---

## Шаг 1. Запуск скрипта

### Важно: путь без кириллицы

Скрипт лучше запускать из каталога, где **в пути нет кириллицы** (например, `Документы` может ломать выполнение). Если проект лежит в `C:\Users\...\OneDrive\Документы\GitHub\regexhelper`, есть два варианта.

### Вариант А: Запуск из корня проекта (если путь без кириллицы)

1. Откройте PowerShell (Win+R → `powershell` → Enter).
2. Перейдите в корень проекта:
   ```
   cd "C:\Users\ВАШ_ПОЛЬЗОВАТЕЛЬ\OneDrive\Документы\GitHub\regexhelper"
   ```
3. Выполните скрипт:
   ```
   .\tools\visualizer\scripts\fetch-regexper-static.ps1
   ```

### Вариант Б: Запуск из каталога без кириллицы

1. Создайте временную папку с путём без кириллицы, например:
   ```
   C:\temp\regexhelper-setup
   ```
2. Скопируйте туда папку `tools` (или только скрипт) и `assets`.
3. Откройте PowerShell и перейдите в корень проекта (или в папку, где есть `tools`):
   ```
   cd C:\temp\regexhelper-setup
   ```
4. Запустите скрипт **с полным путём к целевому каталогу**. Откройте `tools\visualizer\scripts\fetch-regexper-static.ps1` в редакторе и в строке:
   ```powershell
   $TargetDir = Join-Path $PSScriptRoot "..\..\..\assets\libs\regexper"
   ```
   замените на **абсолютный путь** к вашему проекту, например:
   ```powershell
   $TargetDir = "C:\Users\ВАШ_ПОЛЬЗОВАТЕЛЬ\OneDrive\Документы\GitHub\regexhelper\assets\libs\regexper"
   ```
5. Выполните скрипт:
   ```
   .\tools\visualizer\scripts\fetch-regexper-static.ps1
   ```

### Разрешение выполнения скриптов (если PowerShell выдаёт ошибку)

Если появится ошибка вида «выполнение скриптов отключено»:

```
powershell -ExecutionPolicy Bypass -File ".\tools\visualizer\scripts\fetch-regexper-static.ps1"
```

---

## Шаг 2. Что делает скрипт

1. Клонирует [regexper-static](https://gitlab.com/javallone/regexper-static) во временную папку.
2. Устанавливает зависимости (`yarn install`).
3. Собирает проект (`yarn build`).
4. Копирует `main-xxx.js` → `assets/libs/regexper/regexper.js` и `main-xxx.css` → `assets/libs/regexper/regexper.css`.
5. Копирует chunk-файлы (если есть).
6. Удаляет временную папку.

**Итог:** в проекте появляются файлы `assets/libs/regexper/regexper.js` и `assets/libs/regexper/regexper.css`.

> **Важно:** Скрипт копирует «ванильный» бандл без наших правок. После первого запуска или после любого обновления бандла нужно применить **патч отступов** к `regexper.js` — см. раздел [«После обновления бандла: патч отступов»](#после-обновления-бандла-патч-отступов-обязательно) ниже.

---

## Шаг 3. Проверка результата

1. Убедитесь, что папка `assets/libs/regexper/` содержит:
   - `regexper.js`
   - `regexper.css`
2. Если этих файлов нет — в консоли PowerShell могли быть ошибки (кодировка, сеть, отсутствие yarn). Запустите скрипт ещё раз и посмотрите вывод.

**Файлы на месте?** → Переходите к **Шагу 5** (проверка визуализатора в браузере).

---

## Шаг 4. Ручная установка (если скрипт не сработал)

1. Откройте проводник и перейдите в папку **без кириллицы** (например, `C:\work`).
2. В PowerShell выполните:
   ```bash
   git clone https://gitlab.com/javallone/regexper-static.git
   cd regexper-static
   yarn install
   yarn build
   ```
3. Откройте папку `regexper-static\build\` — там будут `main-xxxxxxxx.js` и `main-xxxxxxxx.css`.
4. Скопируйте их в `ВАШ_ПРОЕКТ\assets\libs\regexper\` и переименуйте:
   - `main-xxxxxxxx.js` → `regexper.js`
   - `main-xxxxxxxx.css` → `regexper.css`
5. Если в `build` есть файлы вида `1-xxxxxxxx.js` — скопируйте их в ту же папку без переименования.
6. Примените к скопированному `regexper.js` **патч отступов** — см. раздел [«После обновления бандла: патч отступов»](#после-обновления-бандла-патч-отступов-обязательно).

---

## Шаг 5. Проверка визуализатора

1. Откройте проект в браузере (например, `index.html` через Live Server или локальный сервер).
2. Перейдите к секции «Визуализатор».
3. Введите regex, например: `(a|b)+`
4. Нажмите «Визуализировать».
5. Должна появиться railroad-диаграмма.
6. Нажмите «Скачать» — откроется меню вправо с пунктами SVG и PNG; выберите SVG или PNG — должно начаться скачивание.
7. Проверьте зум (кнопки − и +, при необходимости — Ctrl+колёсико мыши в области диаграммы) и pan (ЛКМ + перетаскивание в области диаграммы).

---

## Откуда берётся regexper и как делаются обновления

- **Всё лежит только в вашем репозитории.** Файлы `assets/libs/regexper/regexper.js` и `regexper.css` — это копии бандла, которые вы один раз получили (скриптом или вручную) и закоммитили. Никакой автоматической связи с GitLab/npm нет.
- **Без ваших действий ничего не изменится и не сломается.** Репозиторий regexper-static не подтягивается автоматически; обновлять бандл нужно только если вы сами решите это сделать (например, взять новую версию с [regexper-static](https://gitlab.com/javallone/regexper-static)).
- **Обновление — только вручную:** снова запустить скрипт `fetch-regexper-static.ps1` или повторить ручную установку (Шаг 4). После каждого обновления обязательно применить **патч отступов** (см. следующий раздел).

---

## После обновления бандла: патч отступов (обязательно)

В проекте к бандлу **regexper.js** применён патч отступов, чтобы элементы диаграммы не наезжали друг на друга и имели «охранные» поля. Ванильный бандл regexper-static использует меньшие значения.

**Если вы обновили regexper** (скопировали новый `regexper.js` из сборки regexper-static), патч нужно **применить заново** к файлу `assets/libs/regexper/regexper.js`:

| В файле regexper.js заменить | На |
|------------------------------|-----|
| `padding: 10`                | `padding: 16` |
| `padding: 5`                 | `padding: 8`  |

- Количество вхождений: `padding: 10` — 2, `padding: 5` — 4. Заменять можно через «Найти и заменить» в редакторе (заменить все).
- **Не трогать** `padding: 0` — его не заменять.

После замены сохраните файл и проверьте визуализатор в браузере. Если в будущем вы обновите бандл и забудете патч — диаграммы снова станут плотными; при необходимости сверяйтесь с этой инструкцией.

---

## Частые ошибки

| Симптом | Решение |
|---------|---------|
| «Бандл regexper не загружен» | Скрипт не выполнен или файлы не попали в `assets/libs/regexper/`. Повторите Шаг 1 или 4. |
| 404 на regexper.js / regexper.css | Файлы отсутствуют или лежат не в `assets/libs/regexper/`. Проверьте путь. |
| Ошибка «Unexpected token '<'» в app.js (консоль) | Из корня проекта выполнить `node temp/temp-trim.js`. См. комментарий в начале `tools/visualizer/app.js`. |
| Ошибка кодировки в PowerShell | Запустите скрипт из каталога без кириллицы (Вариант Б). |
| «yarn не найден» | Установите Node.js и Yarn: `npm install -g yarn` |
| «git не найден» | Установите Git с [git-scm.com](https://git-scm.com/) |

---

## После успешной установки

Визуализатор работает полностью локально, без внешних iframe и обращений к regexper.com. Дополнительные настройки не нужны.

Если нужно сохранить файлы в репозитории:
```bash
git add assets/libs/regexper/regexper.js assets/libs/regexper/regexper.css
git commit -m "Add regexper-static bundle for visualizer"
```
