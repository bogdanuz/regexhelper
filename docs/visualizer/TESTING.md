# Тестирование визуализатора

Как убедиться, что визуализатор ведёт себя так же, как regexper.com, и покрыть сценарии автотестами.

---

## Почему «как у regexper» без своих тестов рендера

Визуализатор использует **тот же бандл**, что и [regexper-static](https://gitlab.com/javallone/regexper-static): `assets/libs/regexper/regexper.js` — их собранный `main-xxx.js` с **локальным патчом отступов** (padding 10→16, 5→8) для увеличения зазоров между элементами. Парсинг и отрисовка railroad-диаграмм выполняются их кодом, мы только:

- подставляем форму и контейнер `#regexp-render`;
- выставляем `location.hash` и вызываем их обработчик `hashchange`;
- синхронизируем наш UI (плейсхолдер, вьюпорт, экспорт) по их состоянию на `body`.

**Вывод:** логика «что нарисовать» и «как нарисовать» — полностью от regexper. Чтобы убедиться, что поведение совпадает с regexper.com, достаточно:

1. Использовать актуальный бандл из regexper-static (скрипт `fetch-regexper-static.ps1`).
2. Проверять вручную или e2e-тестами, что для одних и тех же regex мы получаем диаграмму (и при желании сверять с regexper.com).

Отдельные юнит-тесты на «точное совпадение SVG с regexper.com» не обязательны: при том же бандле результат будет тем же.

---

## Что тестировать

### 1. Наша интеграция (логика, без браузера)

- **Кодирование regex для hash** — та же формула, что у regexper: `encodeURIComponent(expr).replace(/\(/g, '%28').replace(/\)/g, '%29')`. Проверяется в `tests/visualizer-test.mjs`: несколько regex → ожидаемый hash.

### 2. Сценарии в браузере (ручные или e2e)

| Сценарий | Что проверить |
|----------|----------------|
| Валидный regex | Ввести `(a\|b)+`, нажать «Визуализировать» → сразу белое поле, анимация загрузки (три точки по центру) и панель экспорта/зума внизу (без мигания); затем анимация скрывается и показывается диаграмма. |
| Другой regex | `\d+`, `[a-z]+`, `(foo\|bar)?` → диаграмма без ошибок. |
| Невалидный regex | Ввести `(unclosed` → одно сообщение об ошибке (тост + текст в #error), диаграмма не показывается. |
| Пустой ввод | Нажать «Визуализировать» без ввода → toast «Введите регулярное выражение». |
| Зум | Кнопки − и + → масштаб 25–300%, значение «100%» обновляется. Ctrl+колёсико в области диаграммы и в модалке — тот же зум. При зуме < 100% и > 100% диаграмма не обрезается: размеры контейнеров рассчитываются на основе реальных размеров SVG (getBBox) + padding. |
| Pan | Перетаскивание ЛКМ по области диаграммы → скролл области; при зуме диаграмма не обрезается, до всех краёв; pan работает на любом уровне зума. |
| Экспорт | Кнопка «Скачать» открывает меню вправо (SVG, PNG); выбор SVG или PNG → скачивается файл. |
| Вставить | Кнопка «Вставить» вставляет из буфера в поле ввода. |
| Очистить | Кнопка «Очистить» в шапке панели очищает поле ввода и диаграмму. |

### 3. Регрессия после обновления бандла

После пересборки/обновления regexper-static: (1) **обязательно применить патч отступов** к скопированному `regexper.js` (padding: 10 → 16, padding: 5 → 8) — см. **docs/visualizer/SETUP_INSTRUCTIONS.md**, раздел «После обновления бандла: патч отступов»; (2) прогнать те же валидные regex и убедиться, что диаграммы по-прежнему строятся и экспортируются, зум и скролл работают.

---

## Запуск автотестов

### В браузере (tests/test.html)

Откройте **tests/test.html**. Для тестов визуализатора перейдите на вкладку **«Визуализатор»** (при первом открытии вкладки в фоне загружается index.html в iframe). Нажмите **«Запустить тесты визуализатора»**. Запускаются:

- **Visualizer Hash** — кодирование hash (encode/decode, round-trip), smoke для `encodeRegexForHash` из app.js; hash #visualizer очищает поле ввода.
- **Visualizer Export** — формат имени файла `formatDiagramFilename()` (DD-MM-YYYY_HH-mm), кнопка «Скачать» и меню с SVG/PNG (структура, клик открывает меню — класс is-open), скрытые ссылки regexper (download-svg, download-png).
- **Visualizer UI** — элементы в DOM (поле ввода, плейсхолдер, индикатор загрузки — три точки, кнопки Визуализировать/Вставить/Очистить, кнопка «Скачать» и пункты SVG/PNG в меню), зум в одной панели с экспортом; при отображённой диаграмме область имеет класс has-diagram; нет дублированного верхнего тулбара (только нижняя панель); начальное состояние до визуализации (плейсхолдер виден, viewport и панель экспорта скрыты, поле пустое).
- **Visualizer Zoom** — зум без диаграммы не меняет значение; зум с диаграммой в диапазоне 25–300%; диаграмма не обрезается при зуме (контейнеры innerEl и scrollWrap имеют корректные размеры при любом уровне зума).
- **Visualizer Flow** — валидный regex строит диаграмму и показывает панель (ожидание появления SVG, вьюпорта, затем скрытия индикатора загрузки — так отличаем состояние «диаграмма готова» от «идёт загрузка», т.к. панель видна и при загрузке); невалидный regex показывает ошибку и скрывает диаграмму (с ожиданием обновления UI). Перед сценарием невалидного regex в iframe очищаются существующие уведомления (`.notification`), затем проверяется, что появился ровно один тост.
- **Visualizer Fullscreen** — открытие модалки копирует диаграмму; зум в модалке меняет значение; закрытие по кнопке и по клику по оверлею; экспорт SVG из модалки вызывает createObjectURL.

Если iframe ещё не загружен, часть тестов помечается как Skipped; повторно нажмите «Запустить тесты визуализатора» после паузы. На вкладке доступны **Export TEST_RESULTS_FINAL.md**, **Копировать все логи**, **Копировать только ошибки**. В **tests/test.html** пять вкладок: Всё приложение, Конвертер, Визуализатор, Регистр, Тестер. Вкладка **«Всё приложение»** запускает все тесты (конвертер + визуализатор + Регистр + Тестер); при этом для визуализатора при необходимости выполняется сброс состояния iframe и ожидание обновления DOM.

### В Node (без браузера)

```bash
node tests/visualizer-test.mjs
```

Проверяются: кодирование hash (round-trip для нескольких regex, в т.ч. разнообразный набор: якоря, группы, квантификаторы, классы символов, именованные группы) и формат имени файла экспорта (паттерн DD-MM-YYYY_HH-mm). В конце выводится количество пройденных/проваленных и `process.exit(0)` при успехе.

### Экспорт PNG и отладка

Экспорт PNG выполняется своим контуром в app.js: SVG сериализуется с `xmlns`, загружается в `Image` (data URL или при ошибке — Blob URL), рисуется на canvas, затем `canvas.toBlob('image/png')`. При ошибке в консоли браузера (F12 → Console) выводятся сообщения: `PNG export: Image failed to load (blob URL)`, `PNG export: drawImage/toBlob failed`, `PNG export: canvas.toBlob returned null` — по ним можно определить причину сбоя.

---

## E2E (по желанию)

Чтобы автоматически проверять сценарии в браузере (открыть страницу, ввести regex, нажать кнопку, проверить появление SVG), можно добавить:

- **Playwright** или **Puppeteer**: один HTML-файл открывается через `file://` или локальный сервер; скрипт вводит текст, кликает «Визуализировать», проверяет наличие `#regexp-render .svg svg` и при необходимости — отсутствие ошибки в `#error`.

Для «как у regexper» достаточно проверять, что диаграмма появляется для набора валидных regex и что при невалидном regex показывается ошибка. Сравнивать пиксель-в-пиксель с regexper.com не обязательно: при том же бандле результат совпадает.

---

## Чек-лист перед релизом

- [ ] Выполнен `fetch-regexper-static.ps1` (или бандл скопирован вручную), в проекте есть `regexper.js` и `regexper.css`; к `regexper.js` применён патч отступов (см. SETUP_INSTRUCTIONS.md).
- [ ] Запущен `node tests/visualizer-test.mjs` — все тесты зелёные.
- [ ] Вручную или e2e проверены: валидный regex → диаграмма; невалидный → ошибка; зум, pan, SVG/PNG.
- [ ] Конвертер и остальной сайт не затронуты (хедер, стили — по необходимости отражены в `regexper-reset.css`).
