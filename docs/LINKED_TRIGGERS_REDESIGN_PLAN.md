# План редизайна панели связанных триггеров

**Дата создания:** 2026-02-21
**Статус:** ✅ Завершён

---

## Концепция

Переход от текущей сложной структуры (группы → подгруппы → триггеры) к **визуальному конструктору** с горизонтальным потоком элементов (как формула regex).

### Основные принципы:
- **Чипы триггеров** — компактные блоки с текстом
- **Соединители** — бейджи между элементами (`|`, `[\s\S]+`, `.+`, `.{min,max}`)
- **Группы** — цветные рамки вокруг элементов (вложенность — рамка в рамке)
- **Панель параметров справа** — как в простых триггерах

---

## Согласованные решения

### UI/UX
| # | Вопрос | Решение |
|---|--------|---------|
| 1 | Редактирование триггера | Двойной клик → режим редактирования |
| 2 | Удаление элементов | Крестик при наведении + кнопка в панели |
| 3 | Выбор соединителя | Клик на элемент → выбор в панели; или клик на бейдж соединителя |
| 4 | Отображение соединителя | Текстовый бейдж с синтаксисом |
| 5 | Добавление триггера | «+ Триггер» в конец; «+ Вставить после» при выборе элемента |
| 6 | Группировка не-соседних | Ошибка «Выберите соседние элементы» |
| 7 | Панель параметров | Параметры триггера → Соединители → Действия с группой → Конвертировать |
| 8 | Бейджи параметров | Под чипом триггера |
| 9 | Удаление бейджа | Крестик на бейдже + toggle в панели |
| 10 | Миграция данных | Да, конвертировать старые данные |
| 11 | Ширина панели параметров | Фиксированная (~280px) |
| 12 | Стиль чипа | Прямоугольник с закруглёнными углами |
| 13 | Цвета рамок групп | Из палитры проекта |
| 14 | Выделение выбранного | Рамка + тень |
| 15 | Множественный выбор | Ctrl+клик, Shift+клик |
| 16 | Дублирование группы | Копия сразу после оригинала |
| 17 | Undo/Redo | Пока без (подтверждение при удалении) |
| 18 | Новый чип | Сразу в режиме редактирования |
| 19 | Пустая панель | Подсказка «Нажмите + Триггер» |
| 20 | Валидация | При конвертации (пустые игнорируются) |
| 21 | Overflow | Wrap + нумерация строк слева в кружочках + пунктирный разделитель + индикатор «продолжение →» |
| 22 | Очистка панели | Да, с подтверждением |
| 23 | localStorage | Да, сохранять |
| 24 | Подход | Новый модуль с нуля |
| 26 | Нумерация строк | Номера в кружочках (18×18px) + вертикальная пунктирная линия + индикатор «продолжение →» |
| 27 | Подсказки о клавишах | Hint под полем + tooltip на кнопках |
| 28 | Кнопка группировки | «Сгруппировать ( )» |
| 29 | Разгруппировка | Кнопка в панели + правый клик |
| 30 | Соединитель последнего | Применить (для будущих элементов) |

### Визуальный стиль групп
- **Одиночная группа:** цветная рамка
- **Вложенная группа:** рамка в рамке разными цветами из палитры

### Соединители по умолчанию
- Альтернация `|` (применяется автоматически)

### Действия с группой
- **Дублировать:** копия группы со всеми триггерами, параметрами, соединителями
- **Инвертировать:** обратный порядок элементов, соединители «отзеркаливаются»

---

## Структура данных

```javascript
// Массив элементов верхнего уровня
[
  {
    type: 'trigger',        // 'trigger' или 'group'
    id: 'unique-id',
    text: 'слово',          // только для trigger
    params: {               // только для trigger
      latinCyrillic: true,
      wildcard: { mode: 'auto' },
      declensions: { mode: 'auto' },
      wordBoundaries: true,
      requireSpaceAfter: true,
      transliteration: true,
      optionalChars: [0, 3]
    },
    connector: {            // соединитель к следующему элементу
      mode: 'alternation',  // 'alternation' | 'any' | 'paragraph' | 'line' | 'custom'
      min: 0,               // для custom
      max: 10               // для custom
    }
  },
  {
    type: 'group',
    id: 'group-id',
    children: [             // вложенные элементы (рекурсивно)
      { type: 'trigger', ... },
      { type: 'trigger', ... }
    ],
    connector: { mode: 'any' }
  }
]
```

### Соединители (connector.mode)
| mode | Паттерн | Описание |
|------|---------|----------|
| `alternation` | `\|` | Альтернация (ИЛИ) |
| `any` | `[\s\S]+` | Любое расстояние (вкл. переносы) |
| `paragraph` | `.+` | В пределах абзаца |
| `line` | `[^\n]+` | В пределах строки |
| `custom` | `.{min,max}` | Своё значение |

---

## Этапы реализации

### Этап 1: Базовый UI ✅
- [x] Новый HTML панели связанных триггеров
  - Левая часть: интерактивное поле триггеров
  - Правая часть: панель параметров
- [x] Компонент чипа триггера
  - Отображение текста
  - Режим редактирования (двойной клик)
  - Крестик при наведении
- [x] Кнопка «+ Триггер»
- [x] Базовые стили (чипы, layout)
- [x] Подсказка для пустой панели

### Этап 2: Соединители ✅
- [x] Бейджи соединителей между элементами
- [x] Панель выбора соединителей (правая сторона)
- [x] Логика применения соединителя к выбранному элементу
- [x] Клик по бейджу соединителя для изменения
- [x] Соединитель по умолчанию (alternation)

### Этап 3: Группировка ✅
- [x] Выбор элементов (клик, Ctrl+клик, Shift+клик)
- [x] Кнопка «Сгруппировать ( )»
- [x] Проверка соседства выбранных элементов
- [x] Визуальная рамка группы
- [x] Вложенные группы (рамка в рамке)
- [x] Цвета рамок из палитры
- [x] Разгруппировка (кнопка + контекстное меню)

### Этап 4: Параметры триггеров ✅
- [x] Панель параметров (Лат/Кир, Транслит, Склонения, \w, \b, \s)
- [x] Применение параметров к выбранным триггерам
- [x] Бейджи параметров под чипами
- [x] Интеграция с popup'ами (склонения, \w)
- [x] Toggle параметров (повторный клик = отключение)
- [x] Custom connector popup (.{min,max})

### Этап 5: Действия с группами ✅
- [x] Кнопка «Дублировать» (при выборе группы)
- [x] Кнопка «Инвертировать» (при выборе группы)
- [x] Кнопка «Удалить» (для триггеров и групп)
- [x] Подтверждение при удалении группы

### Этап 6: Конвертация ✅
- [x] Новый конвертер для новой структуры данных
- [x] Кнопка «Конвертировать» в панели параметров
- [x] Валидация (пустые триггеры игнорируются)
- [x] Интеграция с панелью результата

### Этап 7: Миграция и очистка ✅
- [x] Функция миграции старых данных в новый формат (migrateFromOldFormat)
- [x] Удаление старого groupManager.js ✅ (2026-02-21)
- [x] Удаление старого linkedConverter.js ✅ (2026-02-21)
- [x] Удаление distanceDropdown.js ✅ (2026-02-21)
- [x] Удаление prefix.js ✅ (2026-02-21)
- [x] Удаление triggerManager.js, dragDrop.js ✅ (2026-02-21)
- [x] Автоматическая миграция при загрузке

### Этап 8: Полировка ✅ Завершён
- [x] Drag & drop (перестановка элементов) — чипы и группы перетаскиваются мышью, индикация позиции вставки, вставка внутрь групп
- [x] Снятие выделения при клике по пустому месту
- [x] Сохранение в localStorage
- [x] Кнопка «Очистить панель» в шапке с подтверждением (модальное окно)
- [x] Нумерация строк (показывается только при 2+ визуальных строках, все номера в кружочках, вертикальная пунктирная линия-разделитель, индикатор «продолжение →» в конце строк)
- [x] Подсказки (tooltips, hints) — подробные
- [x] Адаптивность (базовая в CSS)
- [x] Выравнивание чипов и соединителей в строке (не прыгают)
- [x] Центрирование элементов в группах
- [x] Визуальная связь триггер+соединитель при выделении
- [x] Автоснятие конфликтующих параметров (как в простых триггерах)
- [x] Popup для «Склонения» и «(\w)» работают корректно
- [x] Редактирование пустых чипов по двойному клику
- [x] Кнопка «Удалить» при выборе 2+ триггеров
- [x] Панель «Действия» появляется только при выборе группы
- [x] Модальные окна вместо confirm()
- [x] Обновление документации:
  - STATUS.md
  - USER_REGEX_EXAMPLES_REFERENCE.md
  - DEPENDENCY_MAP.md
  - STRUCTURE.md
  - converter/ARCHITECTURE.md

---

## Файлы для создания/изменения

### Новые файлы
- `tools/converter/ui/linkedBuilder.js` — основной модуль конструктора
- `tools/converter/ui/linkedBuilderUI.js` — UI компоненты (чипы, группы)
- `tools/converter/logic/linkedBuilderConverter.js` — конвертация новой структуры
- `tools/converter/css/linkedBuilder.css` — стили конструктора

### Изменяемые файлы
- `index.html` — новая структура панели связанных триггеров
- `tools/converter/app.js` — интеграция нового модуля
- `tools/converter/css/converter.css` — общие стили (при необходимости)

### Удалённые файлы (аудит 2026-02-21)
- `tools/converter/ui/groupManager.js` — старый менеджер групп ✅
- `tools/converter/ui/triggerManager.js` — старый менеджер триггеров ✅
- `tools/converter/ui/dragDrop.js` — старый drag & drop ✅
- `tools/converter/ui/distanceDropdown.js` — старый UI соединителей ✅
- `tools/converter/logic/linkedConverter.js` — старый конвертер ✅
- `tools/converter/converters/prefix.js` — заменён параметром \w ✅

---

## Прогресс

| Этап | Статус | Дата начала | Дата завершения |
|------|--------|-------------|-----------------|
| 1. Базовый UI | ✅ Завершён | 2026-02-21 | 2026-02-21 |
| 2. Соединители | ✅ Завершён | 2026-02-21 | 2026-02-21 |
| 3. Группировка | ✅ Завершён | 2026-02-21 | 2026-02-21 |
| 4. Параметры | ✅ Завершён | 2026-02-21 | 2026-02-21 |
| 5. Действия с группами | ✅ Завершён | 2026-02-21 | 2026-02-21 |
| 6. Конвертация | ✅ Завершён | 2026-02-21 | 2026-02-21 |
| 7. Миграция | ✅ Завершён | 2026-02-21 | 2026-02-21 |
| 8. Полировка | ✅ Завершён | 2026-02-21 | 2026-02-21 |

---

## Примечания

- ✅ Старый код удалён после успешного тестирования (2026-02-21)
- При возникновении проблем — откат возможен через git
- Каждый этап протестирован перед переходом к следующему
- Все 217 браузерных и 50+ Node тестов проходят успешно
