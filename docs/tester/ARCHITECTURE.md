# Тестер — архитектура

Краткое описание инструмента «Тестер» (проверка regex на тестовой строке): назначение, структура кода, интеграция.

---

## Назначение

Пользователь вводит регулярное выражение и тестовый текст. Совпадения подсвечиваются **прямо в поле** тестового текста (как на regex101). Отдельный блок **Match Information** выводит список совпадений (Совпадение N, диапазон индексов, текст) и под каждым — **Группа 1**, **Группа 2**, … с диапазоном и захваченным текстом. Flavor: **Python (emulated)** — поведение приближено к Python/regex101: препроцессинг паттерна (флаг x), сборка флагов (a/u), при глобальном поиске (g) жадные `[\s\S]*` и `[\s\S]+` заменяются на ленивые варианты, чтобы получать несколько неперекрывающихся совпадений. Поддержка других flavor запланирована.

**Флаги:** g, m (по умолчанию), i, s, u, x, extended, ascii — в выпадающем списке «Флаги regex» в шапке панели.

**Расчёт** выполняется в **Web Worker** с таймаутом 60 с; при превышении — сообщение об ошибке и тост с просьбой упростить паттерн или сократить текст.

---

## Валидация regex и подсветка ошибок

- **Сообщения:** при любой ошибке (нет ответа, Worker, таймаут, синтаксис) в UI показывается одно из двух сообщений: «Неверное регулярное выражение, исправьте ошибку.» (под полем regex) или «Ошибка при проверке регулярного выражения. Попробуйте упростить выражение или обновить страницу.» (Worker/таймаут). Техническое сообщение движка выводится только в консоль браузера.
- **Ошибка только под полем regex:** блок с текстом ошибки отображается только под полем «Регулярное выражение», не под полем тестового текста.
- **Подсветка места ошибки в поле regex:** поле regex имеет оверлей (как поле тестового текста). При ошибке парсинга или при «стилистических» ошибках ошибочные символы подсвечиваются красным в самом поле; поддерживается несколько позиций одновременно (все лишние скобки, лишние `|` и т.д.).
- **Проверки до вызова RegExp** (в `matchRunner.js`): баланс круглых скобок `( )` с учётом символьных классов `[...]` и экранирования; лишняя альтернация в начале (`|...`) и в конце (`...|`); пустая альтернация `||`. Результат — массив `errorIndices` для подсветки всех ошибочных позиций за один проход. При выбросе из `new RegExp(...)` позиция извлекается из сообщения движка или повторной проверки скобок.

---

## Поле тестового текста: оверлей и размеры

- **Высота по умолчанию:** поле «Тестовый текст» имеет `rows="18"`, `min-height: 480px`, `max-height: 1200px` (примерно в 3 раза больше прежнего).
- **Слой подсветки:** размеры оверлея задаются в JS по `clientWidth`/`clientHeight` textarea, чтобы ширина контента и переносы строк совпадали; обновление при инициализации, после каждого результата (`finish`) и при изменении размера (ResizeObserver). У оверлея `overflow: hidden`, скролл только у textarea; позиция скролла синхронизируется при прокрутке и после обновления контента. Пустые совпадения (длина 0) не рисуются — убирается артефакт подсветки в пустом поле.
- **Обрезка по границам:** обёртка поля имеет `overflow: hidden`, `min-height: 480px`, `flex-shrink: 0`, чтобы контент не выходил за границы и блок не сжимался во flex-раскладке.

---

## Структура кода

- **tools/tester/app.js** — точка входа: `initTester()`, `resetTesterPanel()`.
- **tools/tester/logic/** — `patternPreprocess.js` (флаг x: удаление пробелов и комментариев вне `[...]`), `flagsBuilder.js` (сборка строки флагов для RegExp, приоритет a над u), `matchRunner.js` (препроцессинг, при g — замена `[\s\S]*` и `[\s\S]+` на ленивые варианты для эмуляции Python/regex101; проверки скобок и альтернации; создание RegExp; сбор совпадений с группами и indices при поддержке флага d; возврат `{ matches }` или `{ error, errorIndices }`).
- **tools/tester/worker/matchWorker.js** — Web Worker: получает pattern, flagsState, str; вызывает `runMatch`, возвращает результат как есть (в т.ч. `errorIndices`).
- **tools/tester/ui/testerUI.js** — UI: поля regex и test string с оверлеями, выпадающий список флагов, слой подсветки совпадений под textarea (полное совпадение и группы с разными цветами; перекрывающиеся сегменты обрезаются при рендере, чтобы подсветка не сливалась в один блок), слой подсветки ошибок в поле regex; блок Match Information (Совпадение N + под каждым Группа 1, 2, … с диапазоном и текстом); debounce, спиннер при долгом расчёте, тосты при ошибках; синхронизация размеров и скролла оверлея тестового текста с textarea, синхронизация скролла оверлея regex.
- **tools/tester/css/tester.css** — стили панели, полей, оверлеев (в т.ч. `.tester-regex-err-pos`, `.tester-highlight-layer`), выпадающего списка флагов, подсветки совпадений (full match и группы 1–60 с разными цветами), спиннера, Match Information (строки групп с отступом).

---

## Интеграция

- **index.html:** секция `#tester.tester-section` между Визуализатором и Историей; ссылка «Тестер» в навигации; подключён `tools/tester/css/tester.css`.
- **main.js:** импорт и вызов `initTester()` при загрузке DOM.
- **tools/converter/app.js:** в `initHeaderNav()` добавлена секция `#tester` в IntersectionObserver; кнопка «Сбросить» вызывает `resetTesterPanel()`.

Истории у Тестера нет; сброс очищает поля и флаги, сбрасывает результат.

---

## Подсветка совпадений и групп

- **Цвета:** полное совпадение — основной цвет сайта (`.tester-hl-full`); группы 1–9 — фиксированные цвета (зелёный, жёлтый, фиолетовый и т.д.); группы 10–60 — запас из 51 оттенка по HSL (`.tester-hl-g10` … `.tester-hl-g60`), чтобы у каждой группы был свой цвет.
- **Перекрытия:** при нескольких совпадениях сегменты от разных совпадений могут перекрываться по позициям. При построении HTML подсветки каждый символ рисуется не более чем одним сегментом: более поздний по позиции обрезается по текущей позиции вывода, чтобы подсветка не сливалась в один сплошной блок.

## Тесты

- **tests/test.html** — вкладка «Тестер»: браузерные тесты (runMatch, флаги, buildFlagsString, extended, референсные паттерны, нагруженный текст, ошибки паттерна, группы захвата, indices, эмуляция Python: `[\s\S]*`/`[\s\S]+` при g дают несколько совпадений, без g замена не применяется). Кнопка «Запустить тесты Тестер», статистика, Export, Копировать логи/ошибки. Вкладка «Всё приложение» запускает в том числе тесты тестера.
- **tests/tester-test.mjs** — тесты без DOM (Node): runMatch (базовая логика, флаги g/m/i/s/u, невалидный паттерн, пустая строка), buildFlagsString (a без u), applyExtendedFlag (x), референсные паттерны (USER_REGEX_EXAMPLES_REFERENCE), длинный и многострочный текст, ошибки паттерна (скобки, ведущий |), группы захвата и indices, эмуляция Python (ленивые `[\s\S]*` и `[\s\S]+` при g, без g — одно жадное совпадение), много коротких совпадений. Запуск из корня: `node tests/run-tests.mjs` (входит в набор Node-тестов).
- **tests/run-tests.mjs** — при `--browser` (запуск из корня: `node tests/run-tests.mjs`) или `--browser-tester` запускаются браузерные тесты вкладки «Тестер» (Playwright). Для браузера: `npx playwright install`.

---

## Контент

Пользовательские строки (подсказки, кнопки, сообщения) задаются в **index.html** (секция #tester) и **tools/tester/ui/testerUI.js** (блок «Совпадения», единое сообщение об ошибке regex «Неверное регулярное выражение, исправьте ошибку.» и сообщение при Worker/таймауте, тосты).
